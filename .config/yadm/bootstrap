#!/bin/bash

# yadm Bootstrap Script
# This script automatically installs oh-my-zsh plugins and tools when setting up on a new machine

echo "Running yadm bootstrap script..."

# Detect OS
OS="$(uname -s)"

# Install Homebrew packages
if [[ "$OS" == "Darwin" ]]; then
    echo "Installing Homebrew packages..."

    # Check if Homebrew is installed
    if ! command -v brew &> /dev/null; then
        echo "Homebrew not found. Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi

    # Install zoxide if not already installed
    if ! command -v zoxide &> /dev/null; then
        echo "Installing zoxide..."
        brew install zoxide
    fi

    # Install Neovim if not already installed
    if ! command -v nvim &> /dev/null; then
        echo "Installing Neovim..."
        brew install neovim
    fi

    # Install im-select for input method switching (macOS only)
    if ! command -v im-select &> /dev/null; then
        echo "Installing im-select..."
        brew tap daipeihust/tap
        brew install im-select
    fi
fi

# Install oh-my-zsh if not already installed
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    echo "Installing oh-my-zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
fi

# Install zsh-autosuggestions plugin
ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-autosuggestions" ]; then
    echo "Installing zsh-autosuggestions..."
    git clone https://github.com/zsh-users/zsh-autosuggestions "$ZSH_CUSTOM/plugins/zsh-autosuggestions"
else
    echo "zsh-autosuggestions already installed"
fi

# Install zsh-syntax-highlighting plugin
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting" ]; then
    echo "Installing zsh-syntax-highlighting..."
    git clone https://github.com/zsh-users/zsh-syntax-highlighting "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting"
else
    echo "zsh-syntax-highlighting already installed"
fi

# Link custom zsh configs from ~/.config/zsh-custom/ to oh-my-zsh custom directory
if [ -d "$HOME/.config/zsh-custom" ]; then
    echo "Linking custom zsh configs..."

    # Link .zsh files
    for file in "$HOME/.config/zsh-custom"/*.zsh; do
        if [ -f "$file" ]; then
            filename=$(basename "$file")
            if [ ! -e "$ZSH_CUSTOM/$filename" ]; then
                ln -s "$file" "$ZSH_CUSTOM/$filename"
                echo "  Linked $filename"
            fi
        fi
    done

    # Link themes directory
    if [ -d "$HOME/.config/zsh-custom/themes" ] && [ ! -e "$ZSH_CUSTOM/themes" ]; then
        ln -s "$HOME/.config/zsh-custom/themes" "$ZSH_CUSTOM/themes"
        echo "  Linked themes directory"
    fi
fi

echo "Bootstrap complete! Restart your shell to apply changes."
echo ""
echo "üìù Don't forget to:"
echo "  1. Create ~/.env file with your sensitive environment variables"
echo "  2. Open Neovim to let lazy.nvim install plugins: nvim"
