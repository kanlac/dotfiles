#!/bin/bash

# yadm Bootstrap Script
# This script automatically installs oh-my-zsh plugins and tools when setting up on a new machine

echo "Running yadm bootstrap script..."

# Detect OS
OS="$(uname -s)"

# Install Homebrew packages
if [[ "$OS" == "Darwin" ]]; then
    echo "Installing Homebrew packages..."

    # Check if Homebrew is installed
    if ! command -v brew &> /dev/null; then
        echo "Homebrew not found. Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi

    # Install zoxide if not already installed
    if ! command -v zoxide &> /dev/null; then
        echo "Installing zoxide..."
        brew install zoxide
    fi

    # Install Neovim if not already installed
    if ! command -v nvim &> /dev/null; then
        echo "Installing Neovim..."
        brew install neovim
    fi

    # Install im-select for input method switching (macOS only)
    if ! command -v im-select &> /dev/null; then
        echo "Installing im-select..."
        brew tap daipeihust/tap
        brew install im-select
    fi

    # Install jq for JSON processing
    if ! command -v jq &> /dev/null; then
        echo "Installing jq..."
        brew install jq
    fi

    # Install fzf (fuzzy finder)
    if ! command -v fzf &> /dev/null; then
        echo "Installing fzf..."
        brew install fzf
        # Install shell key bindings and fuzzy completion
        $(brew --prefix)/opt/fzf/install --all --no-bash --no-fish
    fi

    # Install Ghostty terminal
    if ! command -v ghostty &> /dev/null; then
        echo "Installing Ghostty..."
        brew install --cask ghostty
    fi
fi

# Install oh-my-zsh if not already installed
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    echo "Installing oh-my-zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
fi

# Install zsh-autosuggestions plugin
# Source .zshrc to get ZSH_CUSTOM definition
if [ -f "$HOME/.zshrc" ]; then
    source "$HOME/.zshrc"
fi
ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-autosuggestions" ]; then
    echo "Installing zsh-autosuggestions..."
    git clone https://github.com/zsh-users/zsh-autosuggestions "$ZSH_CUSTOM/plugins/zsh-autosuggestions"
else
    echo "zsh-autosuggestions already installed"
fi

# Install zsh-syntax-highlighting plugin
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting" ]; then
    echo "Installing zsh-syntax-highlighting..."
    git clone https://github.com/zsh-users/zsh-syntax-highlighting "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting"
else
    echo "zsh-syntax-highlighting already installed"
fi


# ===== Coding Agents Configuration =====
CONFIG_SOURCE="$HOME/.config/agents.json"

if [ -f "$CONFIG_SOURCE" ] && command -v jq &> /dev/null; then
    echo "Applying coding agents configuration..."

    # ----- Claude: Merge MCP servers -----
    CLAUDE_JSON="$HOME/.claude.json"
    if [ -f "$CLAUDE_JSON" ]; then
        jq --slurpfile src "$CONFIG_SOURCE" \
          '.mcpServers = (.mcpServers // {}) * $src[0].claude.mcpServers' \
          "$CLAUDE_JSON" > /tmp/claude.json.tmp && mv /tmp/claude.json.tmp "$CLAUDE_JSON"
    else
        jq '{mcpServers: .claude.mcpServers}' "$CONFIG_SOURCE" > "$CLAUDE_JSON"
    fi
    echo "  Claude MCP servers merged"

    # ----- OpenCode: Merge MCP servers -----
    OPENCODE_JSON="$HOME/.config/opencode/opencode.json"
    if [ -f "$OPENCODE_JSON" ]; then
        jq --slurpfile src "$CONFIG_SOURCE" \
          '.mcp = (.mcp // {}) * $src[0].opencode.mcp' \
          "$OPENCODE_JSON" > /tmp/opencode.json.tmp && mv /tmp/opencode.json.tmp "$OPENCODE_JSON"
        echo "  OpenCode MCP servers merged"
    fi

    # ----- Claude: Install plugins -----
    if command -v claude &> /dev/null; then
        echo "Installing Claude plugins..."
        jq -r '.claude.plugins[]' "$CONFIG_SOURCE" | while read plugin; do
            claude plugins install "$plugin" 2>/dev/null || true
        done
    fi

    # ----- Claude: Merge hooks and enabledPlugins to settings.json -----
    CLAUDE_SETTINGS="$HOME/.claude/settings.json"
    if [ -f "$CLAUDE_SETTINGS" ]; then
        jq --slurpfile src "$CONFIG_SOURCE" '
          .hooks = (.hooks // {}) * $src[0].claude.hooks |
          .enabledPlugins = (.enabledPlugins // {}) * ($src[0].claude.plugins | map({(.): true}) | add)
        ' "$CLAUDE_SETTINGS" > /tmp/settings.json.tmp && mv /tmp/settings.json.tmp "$CLAUDE_SETTINGS"
    else
        mkdir -p "$HOME/.claude"
        jq '{
          hooks: .claude.hooks,
          enabledPlugins: (.claude.plugins | map({(.): true}) | add)
        }' "$CONFIG_SOURCE" > "$CLAUDE_SETTINGS"
    fi
    echo "  Claude hooks and enabledPlugins merged"
fi

echo ""
echo "Bootstrap complete! Restart your shell to apply changes."
echo ""
echo "Don't forget to:"
echo "  1. Create ~/.env file with your sensitive environment variables"
echo "  2. Open Neovim to let lazy.nvim install plugins: nvim"
