#!/bin/bash

# yadm Bootstrap Script
# This script automatically installs oh-my-zsh plugins and tools when setting up on a new machine

echo "Running yadm bootstrap script..."

# Detect OS
OS="$(uname -s)"

# Install Homebrew packages
if [[ "$OS" == "Darwin" ]]; then
    echo "Installing Homebrew packages..."

    # Check if Homebrew is installed
    if ! command -v brew &> /dev/null; then
        echo "Homebrew not found. Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi

    # Function to install brew package if not already installed
    install_brew_package() {
        local cmd="$1"
        local package="$2"
        local extra_args="${3:-}"

        if ! command -v "$cmd" &> /dev/null; then
            echo "Installing $package..."
            brew install $extra_args "$package"
        else
            echo "✓ $package already installed"
        fi
    }

    # Homebrew packages to install
    # Format: "command_name|package_name|extra_args"
    BREW_PACKAGES=(
        "zoxide|zoxide"
        "nvim|neovim"
        "jq|jq"
        "fzf|fzf"
        "rg|ripgrep"
        "fd|fd"
        "ghostty|ghostty|--cask"
    )

    # Install packages
    for pkg_info in "${BREW_PACKAGES[@]}"; do
        IFS='|' read -r cmd package extra_args <<< "$pkg_info"
        install_brew_package "$cmd" "$package" "$extra_args"
    done

    # Special handling: im-select (requires tap)
    if ! command -v im-select &> /dev/null; then
        echo "Installing im-select..."
        brew tap daipeihust/tap
        brew install im-select
    else
        echo "✓ im-select already installed"
    fi

    # Special handling: fzf shell integration
    if command -v fzf &> /dev/null; then
        if [ ! -f "$HOME/.fzf.zsh" ]; then
            echo "Setting up fzf shell integration..."
            $(brew --prefix)/opt/fzf/install --all --no-bash --no-fish
        fi
    fi
fi

# Install oh-my-zsh if not already installed
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    echo "Installing oh-my-zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
fi

# Install zsh-autosuggestions plugin
# Source .zshrc to get ZSH_CUSTOM definition
if [ -f "$HOME/.zshrc" ]; then
    source "$HOME/.zshrc"
fi
ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-autosuggestions" ]; then
    echo "Installing zsh-autosuggestions..."
    git clone https://github.com/zsh-users/zsh-autosuggestions "$ZSH_CUSTOM/plugins/zsh-autosuggestions"
else
    echo "zsh-autosuggestions already installed"
fi

# Install zsh-syntax-highlighting plugin
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting" ]; then
    echo "Installing zsh-syntax-highlighting..."
    git clone https://github.com/zsh-users/zsh-syntax-highlighting "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting"
else
    echo "zsh-syntax-highlighting already installed"
fi


# ===== Coding Agents Configuration =====
CONFIG_SOURCE="$HOME/.config/agents.json"

if [ -f "$CONFIG_SOURCE" ] && command -v jq &> /dev/null; then
    echo "Applying coding agents configuration..."

    # ----- Claude: Merge MCP servers -----
    CLAUDE_JSON="$HOME/.claude.json"
    if [ -f "$CLAUDE_JSON" ]; then
        jq --slurpfile src "$CONFIG_SOURCE" \
          '.mcpServers = (.mcpServers // {}) * $src[0].claude.mcpServers' \
          "$CLAUDE_JSON" > /tmp/claude.json.tmp && mv /tmp/claude.json.tmp "$CLAUDE_JSON"
    else
        jq '{mcpServers: .claude.mcpServers}' "$CONFIG_SOURCE" > "$CLAUDE_JSON"
    fi
    echo "  Claude MCP servers merged"

    # ----- OpenCode: Merge MCP servers -----
    OPENCODE_JSON="$HOME/.config/opencode/opencode.json"
    if [ -f "$OPENCODE_JSON" ]; then
        jq --slurpfile src "$CONFIG_SOURCE" \
          '.mcp = (.mcp // {}) * $src[0].opencode.mcp' \
          "$OPENCODE_JSON" > /tmp/opencode.json.tmp && mv /tmp/opencode.json.tmp "$OPENCODE_JSON"
        echo "  OpenCode MCP servers merged"
    fi

    # ----- Claude: Install plugins -----
    if command -v claude &> /dev/null; then
        echo "Installing Claude plugins..."
        jq -r '.claude.plugins[]' "$CONFIG_SOURCE" | while read plugin; do
            claude plugins install "$plugin" 2>/dev/null || true
        done
    fi

    # ----- Claude: Merge hooks and enabledPlugins to settings.json -----
    CLAUDE_SETTINGS="$HOME/.claude/settings.json"
    if [ -f "$CLAUDE_SETTINGS" ]; then
        jq --slurpfile src "$CONFIG_SOURCE" '
          .hooks = (.hooks // {}) * $src[0].claude.hooks |
          .enabledPlugins = (.enabledPlugins // {}) * ($src[0].claude.plugins | map({(.): true}) | add)
        ' "$CLAUDE_SETTINGS" > /tmp/settings.json.tmp && mv /tmp/settings.json.tmp "$CLAUDE_SETTINGS"
    else
        mkdir -p "$HOME/.claude"
        jq '{
          hooks: .claude.hooks,
          enabledPlugins: (.claude.plugins | map({(.): true}) | add)
        }' "$CONFIG_SOURCE" > "$CLAUDE_SETTINGS"
    fi
    echo "  Claude hooks and enabledPlugins merged"
fi

echo ""
echo "Bootstrap complete! Restart your shell to apply changes."
echo ""
echo "Don't forget to:"
echo "  1. Create ~/.env file with your sensitive environment variables"
echo "  2. Open Neovim to let lazy.nvim install plugins: nvim"
